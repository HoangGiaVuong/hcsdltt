# Pipeline Kho dá»¯ liá»‡u (Data Warehouse) Real-Time - Dá»¯ liá»‡u Taxi NYC

## Tá»•ng quan
Dá»± Ã¡n nÃ y lÃ  má»™t pipeline xá»­ lÃ½ dá»¯ liá»‡u luá»“ng (streaming) 3 lá»›p hoÃ n chá»‰nh, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ mÃ´ phá»ng má»™t Kho dá»¯ liá»‡u (Data Warehouse) thá»i gian thá»±c.

### Má»¥c tiÃªu
- Náº¡p (ingest) bá»™ dá»¯ liá»‡u "NYC Yellow Taxi" tá»« file CSV
- Xá»­ lÃ½ (process) dá»¯ liá»‡u theo thá»i gian thá»±c qua Apache Kafka
- Táº£i (load) dá»¯ liá»‡u vÃ o má»™t LÆ°á»£c Ä‘á»“ HÃ¬nh sao (Star Schema) trong PostgreSQL

> Há»‡ thá»‘ng nÃ y Ä‘Æ°á»£c xÃ¢y dá»±ng lÃ m "sÃ¢n chÆ¡i" (sandbox) Ä‘á»ƒ thá»­ nghiá»‡m cÃ¡c ká»¹ thuáº­t Tá»‘i Æ°u hÃ³a Truy váº¥n NÃ¢ng cao (nhÆ° Láº­p chá»‰ má»¥c, Káº¿ hoáº¡ch Thá»±c thi Äá»™ng, vÃ  giÃ¡m sÃ¡t ML) Ä‘Æ°á»£c mÃ´ táº£ trong bÃ i bÃ¡o nghiÃªn cá»©u.

## ğŸš€ Kiáº¿n trÃºc Há»‡ thá»‘ng

Pipeline bao gá»“m 3 lá»›p pháº§n má»m, cháº¡y song song vÃ  Ä‘Æ°á»£c káº¿t ná»‘i bá»Ÿi Apache Kafka.

### Lá»›p 1: Ingestion (Thu tháº­p) - csv_producer.py

**Äáº§u vÃ o:** Äá»c file yellow_tripdata_2015-01.csv (hoáº·c file Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong config.ini)

> **Táº¢I Vá»€ Tá»ª:** https://www.kaggle.com/datasets/elemento/nyc-yellow-taxi-trip-data/data

**CÃ´ng viá»‡c:**
- Láº¥y máº«u (sample) cÃ¡c dÃ²ng ngáº«u nhiÃªn tá»« file
- Äá»c táº¥t cáº£ dá»¯ liá»‡u dÆ°á»›i dáº¡ng chuá»—i (str) Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n
- "PhÃ¡t" (produce) tin nháº¯n JSON vÃ o topic Kafka taxi_trips_raw

**Má»¥c Ä‘Ã­ch:** Giáº£ láº­p má»™t nguá»“n dá»¯ liá»‡u "live" (trá»±c tiáº¿p) Ä‘ang liÃªn tá»¥c táº¡o ra cÃ¡c chuyáº¿n Ä‘i

### Lá»›p 2: Processing (Xá»­ lÃ½) - stream_processor.py

**Äáº§u vÃ o:** Láº¯ng nghe topic taxi_trips_raw

**CÃ´ng viá»‡c:**
- Nháº­n cÃ¡c tin nháº¯n JSON thÃ´
- "Dá»n dáº¹p" (clean) vÃ  "biáº¿n Ä‘á»•i" (transform) dá»¯ liá»‡u
- Xá»­ lÃ½ cÃ¡c kiá»ƒu dá»¯ liá»‡u vÃ  giÃ¡ trá»‹ rá»—ng (nan)

**Äáº§u ra:** Gá»­i dá»¯ liá»‡u Ä‘Ã£ sáº¡ch sang topic taxi_trips_clean

### Lá»›p 3: Storage (LÆ°u trá»¯) - postgres_consumer.py

**Äáº§u vÃ o:** Láº¯ng nghe topic taxi_trips_clean

**CÃ´ng viá»‡c:**
- Thiáº¿t láº­p CSDL (Láº§n cháº¡y Ä‘áº§u tiÃªn)
- Táº¡o LÆ°á»£c Ä‘á»“ HÃ¬nh sao (Star Schema) gá»“m 6 báº£ng
- Náº¡p Báº£ng Dim
- Cháº¡y liÃªn tá»¥c vÃ  thá»±c hiá»‡n INSERT hÃ ng loáº¡t

## ğŸ“‹ YÃªu cáº§u Pháº§n má»m

- Docker vÃ  Docker Compose
- Python 3.8+
- File dá»¯ liá»‡u yellow_tripdata_2015-01.csv

## âš™ï¸ CÃ i Ä‘áº·t & Cáº¥u hÃ¬nh

### 1. Táº£i Dá»¯ liá»‡u
Táº£i file yellow_tripdata_2015-01.csv vÃ  Ä‘áº·t vÃ o thÆ° má»¥c dá»± Ã¡n

### 2. CÃ i Ä‘áº·t ThÆ° viá»‡n Python
Táº¡o file requirements.txt:
```
kafka-python
pandas
psycopg2-binary
```

CÃ i Ä‘áº·t thÆ° viá»‡n:
```bash
pip install -r requirements.txt
```

### 3. Kiá»ƒm tra Cáº¥u hÃ¬nh (config.ini)
- **[APPLICATION_SETTINGS]**: Cáº¥u hÃ¬nh Ä‘Æ°á»ng dáº«n file CSV
- **[POSTGRES]**: Cáº¥u hÃ¬nh tÃªn CSDL
- **[TOPICS]**: Cáº¥u hÃ¬nh tÃªn cÃ¡c topic

## âš¡ HÆ°á»›ng dáº«n cháº¡y

### Terminal 1: Khá»Ÿi Ä‘á»™ng Háº¡ táº§ng
```bash
docker-compose up -d
```

### Terminal 2: Cháº¡y Lá»›p 3 (LÆ°u trá»¯)
```bash
python postgres_consumer.py
```

### Terminal 3: Cháº¡y Lá»›p 2 (Xá»­ lÃ½)
```bash
python stream_processor.py
```

### Terminal 4: Cháº¡y Lá»›p 1 (PhÃ¡t dá»¯ liá»‡u)
```bash
python csv_producer.py
```

### Terminal 5: Kiá»ƒm tra Káº¿t quáº£
```bash
docker-compose exec postgres psql -U admin -d taxi_data_db
```

CÃ¡c truy váº¥n kiá»ƒm tra:
```sql
-- Äáº¿m sá»‘ dÃ²ng
SELECT COUNT(*) FROM Fact_Trips;

-- Kiá»ƒm tra Star Schema
SELECT
    p.payment_type_name,
    COUNT(f.trip_id_pk) AS so_luong_chuyen
FROM
    Fact_Trips f
JOIN
    Dim_Payment_Type p ON f.payment_type_fk = p.payment_type_pk
GROUP BY
    p.payment_type_name
ORDER BY
    so_luong_chuyen DESC;
```

## â¹ï¸ Dá»«ng Há»‡ thá»‘ng

```bash
docker-compose down
# Hoáº·c xÃ³a hoÃ n toÃ n volume:
docker-compose down -v
```

## ğŸš€ Tá»‘i Æ°u hÃ³a Truy váº¥n

### 1. PhÃ¢n tÃ­ch Query
```sql
EXPLAIN ANALYZE
SELECT ... -- cÃ¢u query JOIN á»Ÿ trÃªn
```

### 2. Táº¡o Index
```sql
CREATE INDEX idx_fact_payment_fk ON Fact_Trips(payment_type_fk);
```

### 3. GiÃ¡m sÃ¡t Hiá»‡u nÄƒng
```sql
SELECT total_exec_time, calls, mean_exec_time, query
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```
